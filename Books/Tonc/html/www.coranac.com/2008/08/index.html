

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
  <meta http-equiv="Content-Type"
    content="text/html; charset=UTF-8" />

  <title>Coranac &raquo; 2008 &raquo; August</title>

  <!-- leave this for stats please -->
    <meta name="generator" content="WordPress 2.7.1" />

  <style type="text/css">
    @import url( http://www.coranac.com/wordpress/wp-content/themes/crn/style.css );
  </style>

  <script language="JavaScript" type="text/javascript" src="http://www.coranac.com/crn.js"></script>

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
    href="http://www.coranac.com/feed/" />
  <link rel="alternate" type="text/xml" title="RSS .92"
    href="http://www.coranac.com/feed/rss/" />
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3"
    href="http://www.coranac.com/feed/atom/" />

  <link rel="pingback" href="http://www.coranac.com/wordpress/xmlrpc.php" />
		<link rel='archives' title='June 2009' href='http://www.coranac.com/2009/06/' />
	<link rel='archives' title='May 2009' href='http://www.coranac.com/2009/05/' />
	<link rel='archives' title='April 2009' href='http://www.coranac.com/2009/04/' />
	<link rel='archives' title='February 2009' href='http://www.coranac.com/2009/02/' />
	<link rel='archives' title='December 2008' href='http://www.coranac.com/2008/12/' />
	<link rel='archives' title='November 2008' href='http://www.coranac.com/2008/11/' />
	<link rel='archives' title='September 2008' href='http://www.coranac.com/2008/09/' />
	<link rel='archives' title='August 2008' href='http://www.coranac.com/2008/08/' />
	<link rel='archives' title='June 2008' href='http://www.coranac.com/2008/06/' />
	<link rel='archives' title='May 2008' href='http://www.coranac.com/2008/05/' />
	<link rel='archives' title='April 2008' href='http://www.coranac.com/2008/04/' />
	<link rel='archives' title='February 2008' href='http://www.coranac.com/2008/02/' />
	<link rel='archives' title='January 2008' href='http://www.coranac.com/2008/01/' />
	<link rel='archives' title='December 2007' href='http://www.coranac.com/2007/12/' />
	<link rel='archives' title='November 2007' href='http://www.coranac.com/2007/11/' />
	<link rel='archives' title='October 2007' href='http://www.coranac.com/2007/10/' />
	<link rel='archives' title='June 2007' href='http://www.coranac.com/2007/06/' />
	<link rel='archives' title='April 2007' href='http://www.coranac.com/2007/04/' />
	<link rel='archives' title='March 2007' href='http://www.coranac.com/2007/03/' />
	<link rel='archives' title='February 2007' href='http://www.coranac.com/2007/02/' />
	<link rel='archives' title='January 2007' href='http://www.coranac.com/2007/01/' />
	<link rel='archives' title='August 2006' href='http://www.coranac.com/2006/08/' />
		<link rel="stylesheet" href="http://www.coranac.com/wordpress/wp-content/plugins/codesnippet/codesnippet.css" type="text/css" />
<style type="text/css">
.codesnip-container	{border:1px solid #ccc; background:#eee; padding: 5px;margin:10px;}
</style>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.coranac.com/wordpress/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.coranac.com/wordpress/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 2.7.1" />

</head>

<body onload="main();">
<div id="rap">
<h1 id="header">
	<a href="http://www.coranac.com/">Coranac</a>
</h1>

<div id="content">
<!-- end header -->

<div class="post" id="post-55">
	<div class="storyheader">
		<h3 class="storytitle"><a href="http://www.coranac.com/2008/08/21/define-overthinking/" rel="bookmark">
		Define: overthinking</a></h3>
		<div class="meta">
		2008-08-21 &ndash; 20:07 | <ul class="post-categories">
	<li><a href="http://www.coranac.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></li></ul>. 
		</div>
	</div>
	<div class="storycontent">
		<div>&lt;ramble&gt;</div>

<p>
I think too much. Or so people keep telling me. And they may have a 
point.
</p>
<p>
Anyway, so I'm working on this assembly version of 
<a href="http://www.coranac.com/2008/01/25/tonccpy/">toncset</a> 
for, well, just because I guess. A fill
routine has 3 parts: a head, a main run and a tail. The main part 
fills 32-bit chunks (words) when there's more than 4 bytes left and 
when the destination is word-aligned. This part is easy, because 
you can just dump words with <code>stmia</code> or <code>str</code>.
For an example of this, see my older 
<a href="http://www.coranac.com/2007/11/09/new-memset16-routine/">memset16 post</a>.
</p>
<p>
The tail is for the remaining bytes after the main part. Under normal 
circumstances you could do this byte for byte, but some sections of 
GBA/NDS memory do not take kindly to byte-writes, so you'd have to 
read the word, mask the appropriate bytes out/in and then write it 
back. This is mostly just annoying, but still very doable.
</p>
<p>
The head part, however, is both annoying and tricky. It consist of 
filling the unaligned bytes in the first word of a run so that the 
main part can do its thing. This is similar to the tail part, in that
it requires bitmasks. However, it's also possible that both the
beginning <i>and</i> and of a run occur in the same word, effectively 
making the head the tail as well, so you'd have to apply a double mask
&hellip; somehow. In C, it looks something like this:
</p>

<div class="cpp"><div class="cpp proglist" style=" "><span class="coMULTI">/* Input:<br />
&nbsp; void *dstv; &nbsp; // potentially non-aligned<br />
&nbsp; u32 fill; &nbsp; &nbsp; // Already extended to full 32-bit if appropriate.<br />
&nbsp; uint size;&nbsp; &nbsp; // &gt; 0<br />
*/</span><br />
<br />
u32 addr= (u32)dstv;<br />
<span class="kw1">int</span> left= addr&amp;<span class="nu0">3</span>;<br />
<span class="kw1">if</span>(left != <span class="nu0">0</span>)<br />
{<br />
&nbsp; &nbsp; u32 *dst= (u32*)(addr&amp;~<span class="nu0">3</span>);<br />
&nbsp; &nbsp; <span class="kw1">int</span> right= left+size;<br />
&nbsp; &nbsp; u32 mask= <span class="nu0">0xFFFFFFFF</span>;<br />
<br />
&nbsp; &nbsp; <span class="kw1">if</span>(right &lt; <span class="nu0">4</span>) &nbsp; <span class="co1">// Everything in a single word: head and tail.</span><br />
&nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; mask= ~(mask&lt;&lt;<span class="nu0">8</span>*size);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Create right-mask 000F</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; mask &lt;&lt;= <span class="nu0">8</span>*left;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Create mid mask 00F0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; *dst = (*dst &amp;~ mask) | (fill &amp; mask);<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span>;<br />
&nbsp; &nbsp; }<br />
&nbsp; &nbsp; <span class="kw1">else</span><br />
&nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; mask &lt;&lt;= <span class="nu0">8</span>*left;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Create left mask FFF0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; *dst = (*dst &amp;~ mask) | (fill &amp; mask);<br />
&nbsp; &nbsp; &nbsp; &nbsp; size= right-<span class="nu0">4</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; *dst++;<br />
&nbsp; &nbsp; }<br />
}</div></div>

<p>
This bit of C translates roughly into the following ARM code:
</p>

<div class="gccarm"><div class="gccarm proglist" style=" ">&nbsp; &nbsp; <span class="co1">@ Reglist</span><br />
&nbsp; &nbsp; <span class="co1">@ r0 : dst</span><br />
&nbsp; &nbsp; <span class="co1">@ r1 : src</span><br />
&nbsp; &nbsp; <span class="co1">@ r2 : size</span><br />
&nbsp; &nbsp; <span class="co1">@ r3 : left (dst&amp;3) / right (left+size) / data</span><br />
&nbsp; &nbsp; <span class="co1">@ r4 : lshift (left*8)</span><br />
&nbsp; &nbsp; <span class="co1">@ r5 : rshift (right*8) / mask</span><br />
&nbsp; &nbsp; <span class="co1">@ ip : maskBase (0xFFFFFFFF)</span><br />
.Lfgset_head:<br />
&nbsp; &nbsp; <span class="re1">bic</span> &nbsp; &nbsp; <span class="kw2">r0</span>, <span class="kw2">r0</span>,#<span class="nu0">3</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Align dst</span><br />
&nbsp; &nbsp; <span class="re1">mvn</span> &nbsp; &nbsp; <span class="kw2">ip</span>, #<span class="nu0">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Set-up mask (0xFFFFFFFF)</span><br />
&nbsp; &nbsp; <span class="re1">mov</span> &nbsp; &nbsp; <span class="kw2">r4</span>, <span class="kw2">r3</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ (left*=8) != 0 : right-side only</span><br />
&nbsp; &nbsp; <span class="re1">add</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw2">r2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ right= left+size</span><br />
&nbsp; &nbsp; <span class="re1">cmp</span> &nbsp; &nbsp; <span class="kw2">r3</span>, #<span class="nu0">4</span><br />
<br />
&nbsp; &nbsp; <span class="co1">@ &lt;= 4 : single-word. Shrink mask, do usual and quit early</span><br />
&nbsp; &nbsp; <span class="re1">movlo</span> &nbsp; <span class="kw2">r5</span>, <span class="kw2">r2</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ \.</span><br />
&nbsp; &nbsp; <span class="re1">mvnlo</span> &nbsp; <span class="kw2">ip</span>, <span class="kw2">ip</span>, <span class="kw1">lsl</span> <span class="kw2">r5</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ - r5= ((1&lt;&lt;8*size)-1)&lt;&lt;(8*left);</span><br />
&nbsp; &nbsp; <span class="re1">mov</span> &nbsp; &nbsp; <span class="kw2">r5</span>, <span class="kw2">ip</span>, <span class="kw1">lsl</span> <span class="kw2">r4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ /</span><br />
<br />
&nbsp; &nbsp; <span class="re1">subhi</span> &nbsp; <span class="kw2">r2</span>, <span class="kw2">r3</span>, #<span class="nu0">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Adjust size for follow-ups</span><br />
<br />
&nbsp; &nbsp; <span class="co1">@ Mask in r1 and write back to dst</span><br />
&nbsp; &nbsp; <span class="re2">ldr</span> &nbsp; &nbsp; <span class="kw2">r3</span>, [<span class="kw2">r0</span>]<br />
&nbsp; &nbsp; <span class="re1">bic</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw2">r5</span><br />
&nbsp; &nbsp; <span class="re1">and</span> &nbsp; &nbsp; <span class="kw2">r5</span>, <span class="kw2">r1</span>, <span class="kw2">r5</span><br />
&nbsp; &nbsp; <span class="re1">orr</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r5</span><br />
&nbsp; &nbsp; <span class="re2">str</span> &nbsp; &nbsp; <span class="kw2">r3</span>, [<span class="kw2">r0</span>], #<span class="nu0">4</span><br />
<br />
&nbsp; &nbsp; <span class="re2">bhi</span> &nbsp; &nbsp; .Lfgset_main&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Longer stretch : go back.</span><br />
&nbsp; &nbsp; <span class="re2">bx</span>&nbsp; &nbsp; &nbsp; <span class="kw2">lr</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Single-word fill : finished.</span></div></div>

<p>
The main thing I thought when I'd written this down was &ldquo;meh&rdquo;.
You will note that registers <code>r4</code> and <code>r5</code> are
used here, which means stack-work (omitted here for brevity). The 
positioning of pushing and popping makes everything a little awkward, 
so I was off looking for something else.
</p>
<p>
The essence of the problem here is that you can only use five registers
without touching the stack: <code>r0-r3</code> and <code>ip</code>
(<code>r12</code>). Now, <code>r0-r2</code> are taken
by the destination, fill and size, so I can't do anything with those. 
I also need one to store the left-edge (<code>r3</code> in this case), 
leaving us with one for the right edge, the left and right shift
intermediaries, and the left and right masks. Right! Crap <kbd>-_-</kbd>.
</p><br />
<p>
So; strategies. Well, one of the reasons I need to use so many 
registers is because the lifetimes overlap. For example, I still need
<code>left</code> for a while because shifting the mask up comes last 
here. I can't use <code>r2</code> for multiple purposes either because 
I'll need it for the size. Now, I could free up <code>r3</code> by 
making the left-mask first, but then I might get in trouble when creating 
the right-mask. Also, <code>right-4</code> is actually
what <code>size</code> wants to be when it grows up in the long-run 
case, so I can use that there as well. I'd just have to undo that 
for the short case, or perhaps even create the right-mask from
negative numbers.
</p>
<p>
At this point I figured it would be helpful to take a look at the 
various ways of creating the masks I needed. The standard form for a 
0x000000FF-style bitmask is <code>(1&lt;&lt;x)-1</code>, but there are
others as well. The following list holds a few examples.
</p>

<div class="cpp"><div class="cpp proglist" style=" "><span class="co1">// Bitmask examples. Assume x=8 (in r1)</span><br />
<br />
&nbsp;( <span class="nu0">1</span>&lt;&lt;x)-<span class="nu0">1</span>; &nbsp; &nbsp; <span class="co1">// 000000FF.&nbsp; &nbsp; mov r0, #1; rsb r0, r0, r0, lsl r1;</span><br />
~(-<span class="nu0">1</span>&lt;&lt;x); &nbsp; &nbsp; &nbsp; <span class="co1">// 000000FF.&nbsp; &nbsp; mvn r0, #0; mvn r0, r0, lsl r1;</span><br />
&nbsp; -<span class="nu0">1</span>&lt;&lt;x;&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// FFFFFF00.&nbsp; &nbsp; mvn r0, #0; mov r0, r0, lsl r1;</span><br />
-( <span class="nu0">1</span>&lt;&lt;x); &nbsp; &nbsp; &nbsp; <span class="co1">// FFFFFF00.&nbsp; &nbsp; mov r0, #1; sub r0, r0, r0 lsl r1; sub r0, #1</span><br />
&nbsp; -<span class="nu0">1</span>&gt;&gt;x;&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// 00FFFFFF.&nbsp; &nbsp; mvn r0, #0; mov r0, r0, lsr r1;</span><br />
~(-<span class="nu0">1</span>&gt;&gt;x); &nbsp; &nbsp; &nbsp; <span class="co1">// FF000000.&nbsp; &nbsp; mvn r0, #0; mvn r0, r0, lsl r1;</span></div></div>

<p>
All of these use +1 or &minus;1 as their base, and all but one is 
a two-instruction affair. The left-mask looks like 0xFFFFFF00, so
the most obvious one to pick here is <code>-1&lt;&lt;x</code>. 
Technically, the right-mask is 0x000000FF, using 
<code>x&nbsp;=&nbsp;8*right&nbsp;=&nbsp;8*(left+size)</code>. 
However, you can also see it as a 0x00FFFFFF-style mask if you
use <code>4-right</code>. This solves two problems at once. First, 
it is the negative of the new size, so the value is readily available. 
Second, this mask is a right-shifted 0xFFFFFFFF, but as the lower bits 
are shifted out anyway, it doesn't actually have to be a proper
0xFFFFFFFF; it can be a 0xFFFFFF00 as well, which we have in the form
of the left-mask. In other words, we don't require as many registers 
for temps because we already have everything we need. The resulting
code is this:
</p>

<div class="gccarm"><div class="gccarm proglist" style=" ">&nbsp; &nbsp; <span class="re1">add</span> &nbsp; &nbsp; <span class="kw2">r2</span>, <span class="kw2">r3</span>, <span class="kw2">r2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ (1a) right := left+size.</span><br />
&nbsp; &nbsp; <span class="re1">movs</span>&nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span><br />
&nbsp; &nbsp; <span class="re1">mvn</span> &nbsp; &nbsp; <span class="kw2">ip</span>, #<span class="nu0">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ ip= -1</span><br />
&nbsp; &nbsp; <span class="re1">mov</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">ip</span>, <span class="kw1">lsl</span> <span class="kw2">r3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ lmask := (-1)&lt;&lt;(8*left)</span><br />
&nbsp; &nbsp; <span class="re1">subs</span>&nbsp; &nbsp; <span class="kw2">r2</span>, <span class="kw2">r2</span>, #<span class="nu0">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ (1b) aligned size= right-4</span><br />
<br />
&nbsp; &nbsp; <span class="co1">@ new size &lt; 0 : single-word fill</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re1">rsblo</span> &nbsp; <span class="kw2">r2</span>, <span class="kw2">r2</span>, #<span class="nu0">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ - (2) r3= -8*size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re1">movlo</span> &nbsp; <span class="kw2">r2</span>, <span class="kw2">r2</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span>&nbsp; &nbsp; &nbsp; <span class="co1">@ /</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re1">andlo</span> &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw1">lsr</span> <span class="kw2">r2</span>&nbsp; <span class="co1">@ (3) mask = lmask &amp; rmask</span><br />
&nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="co1">@# inserts and jumps</span></div></div>
<p>
See? No <code>r4</code> and <code>r5</code> anywhere. The 
key is toying around with <code>r2</code> and <code>r3</code>. While 
<code>r2</code> is reserved for the size, it needs to modified anyway 
to account for the work done here. In the end, size should be
right&minus;4, which is what points (1a) and (1b) do. Since 
<code>right-4</code> is a <code>right&lt;4</code> as well, we can use 
its result as the condition for the special case; the result 
being the negative distance from the word-edge. As explained above,
the right-mask can be constructed from the left-mask by 
<code>lmask&gt;&gt;(-8*size)</code>, which is done at points (2) and 
(3).
</p>
<p>
It's a little hairy, but it works. And yet, it still evoked a feeling 
of &ldquo;meh&rdquo; like before. It's the two instructions at point (2) that annoyed me. The reason it's two instructions and not one is because you 
can't multiply by &minus;8 in one go. By +8, yes: that's a
shifted-<code>mov</code>; &minus;1, yes: that's
<code>rsb,&nbsp;r2,&nbsp;#0</code>; but the combination is difficult
because the shift only applies to the second operand. A
<code>sub r2,&nbsp;#0,&nbsp;r2,&nbsp;lsl&nbsp;#3</code> would do it,
but the first operand needs to be a register and I don't have a spare 
one with zero in it. I could make one, that just means I have an 
extra instruction somewhere else. I <i>do</i>, however, have either 
a +1 or &minus;1 in <code>ip</code>, maybe I can use that somehow. 
And then it hits me: the carry flag!
</p>
<p>
There are <code>adc</code>, <code>sbc</code> and <code>rsb</code>
instructions that add <i>C</i>, <i>C</i>&minus;1 and <i>C</i>&minus;1
to the result, respectively. Setting or clearing the carry flag is 
easy, so that's not a problem. All I need now is to start the 
flag using +1 instead of &minus;1 to cancel out the &minus;1 in <code>sbc</code> or <code>rsc</code>. As it turns out, I can do that 
I use this format for the left-mask: <code>-(1&lt;&lt;x)</code>. In the 
mask overview above I listed thi as a 3-instruction gig, but as it turns 
out I can use the carry-trick here to for one instruction less. The final 
version (for just the head part) looks like this:
</p>

<div class="gccarm"><div class="gccarm proglist" style=" ">&nbsp; &nbsp; <span class="re1">ands</span>&nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r0</span>, #<span class="nu0">3</span><br />
&nbsp; &nbsp; <span class="re2">beq</span> &nbsp; &nbsp; .Lfgset_main&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Jump to main stint is aligned</span><br />
<br />
.Lfgset_head:<br />
&nbsp; &nbsp; <span class="re1">bic</span> &nbsp; &nbsp; <span class="kw2">r0</span>, <span class="kw2">r0</span>, #<span class="nu0">3</span><br />
&nbsp; &nbsp; <span class="re1">add</span> &nbsp; &nbsp; <span class="kw2">r2</span>, <span class="kw2">r3</span>, <span class="kw2">r2</span><br />
&nbsp; &nbsp; <span class="re1">movs</span>&nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ left*8 ; clear carry</span><br />
&nbsp; &nbsp; <span class="re1">mov</span> &nbsp; &nbsp; <span class="kw2">ip</span>, #<span class="nu0">1</span><br />
&nbsp; &nbsp; <span class="re1">sbc</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">ip</span>, <span class="kw2">ip</span>, <span class="kw1">lsl</span> <span class="kw2">r3</span>&nbsp; &nbsp; &nbsp; <span class="co1">@ -(1&lt;&lt;8*left) +1-1</span><br />
&nbsp; &nbsp; <span class="re1">subs</span>&nbsp; &nbsp; <span class="kw2">r2</span>, <span class="kw2">r2</span>, #<span class="nu0">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ size= right-4</span><br />
<br />
&nbsp; &nbsp; <span class="co1">@ If negative (==carry clear), this is a single-word fill</span><br />
&nbsp; &nbsp; <span class="co1">@ This requires a truncated mask (like 0x0000FF00)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re1">sbclo</span> &nbsp; <span class="kw2">r2</span>, <span class="kw2">ip</span>, <span class="kw2">r2</span>, <span class="kw1">lsl</span> #<span class="nu0">3</span>&nbsp; &nbsp; &nbsp; <span class="co1">@ x= -8*size +1-1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re1">andlo</span> &nbsp; <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw2">r3</span>, <span class="kw1">lsr</span> <span class="kw2">r2</span>&nbsp; &nbsp; &nbsp; <span class="co1">@ mask= mask &amp; (mask&gt;&gt;-8*size);</span><br />
<br />
&nbsp; &nbsp; <span class="co1">@ Insert and jump to main stint if available.</span><br />
.Lfgset_insert:<br />
&nbsp; &nbsp; <span class="re2">ldr</span> &nbsp; &nbsp; <span class="kw2">ip</span>, [<span class="kw2">r0</span>]<br />
&nbsp; &nbsp; <span class="re1">bic</span> &nbsp; &nbsp; <span class="kw2">ip</span>, <span class="kw2">ip</span>, <span class="kw2">r3</span><br />
&nbsp; &nbsp; <span class="re1">and</span> &nbsp; &nbsp; <span class="kw2">r3</span>, <span class="kw2">r1</span>, <span class="kw2">r3</span><br />
&nbsp; &nbsp; <span class="re1">orr</span> &nbsp; &nbsp; <span class="kw2">ip</span>, <span class="kw2">ip</span>, <span class="kw2">r3</span><br />
&nbsp; &nbsp; <span class="re2">str</span> &nbsp; &nbsp; <span class="kw2">ip</span>, [<span class="kw2">r0</span>], #<span class="nu0">4</span><br />
<br />
&nbsp; &nbsp; <span class="re2">bhi</span> &nbsp; &nbsp; .Lfgset_main&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Longer stretch</span><br />
&nbsp; &nbsp; <span class="re2">bx</span>&nbsp; &nbsp; &nbsp; <span class="kw2">lr</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">@ Single-word fill : finished.</span></div></div>

<p>
Sweeeet <kbd>:)</kbd>. I was happy with this, until I realized what I'd 
been working on: an exception of an exception. This would definitely 
<i>not</i> be part of the 20% of the code that uses 80% of the runtime,
so it's really not something one should worry about. Interesting, yes, 
and I learned a few new tricks, but perhaps time would have been better 
spent on getting 5% extra out of the main loop. The only problem there 
is that that is just boring old unrolling a bit, whereas the head
presented a more &lsquo;interesting&rsquo; problem so I went for that
instead.
</p>
<p>
So yeah; I think too much <kbd>&gt;_&gt;</kbd>
</p>

<div>&lt;/ramble&gt;</div>
	</div>
	<div class="feedback">
		<a href="http://www.coranac.com/2008/08/21/define-overthinking/#comments" title="Comment on Define: overthinking">Comments (5)</a>	</div>
</div>

<div class="post" id="post-54">
	<div class="storyheader">
		<h3 class="storytitle"><a href="http://www.coranac.com/2008/08/19/tonc-14-official-release/" rel="bookmark">
		tonc 1.4 official release</a></h3>
		<div class="meta">
		2008-08-19 &ndash; 15:05 | <ul class="post-categories">
	<li><a href="http://www.coranac.com/category/proj/tonc/" title="View all posts in tonc" rel="category tag">tonc</a></li></ul>. 
		</div>
	</div>
	<div class="storycontent">
		<p>
The files have need downloadable for a while now as a preview, but I finally put the text up on the <a href="http://www.coranac.com/tonc">main site</a> as well so I guess that makes it official. Tonc is now at version 1.4. As mentioned before, the main new thing is <a href="http://www.coranac.com/tonc/text/tte.htm">TTE</a>, a system for text for all occasions. I've also used grit in some of the advanced demos, so if you want to see how you can do advanced work with it, check out the mode 7 demos and the tte demo.
</p>
<p>
This will be the last version of Tonc. It's really gone on long enough now.
</p><br />

<p>Files and linkies :</p>

<ul>
  <li>Main site : <a href="http://www.coranac.com/tonc">www.coranac.com/tonc</a>
  </li>
  <li>
    Tonclib manual : <a href="http://www.coranac.com/man/tonclib/">www.coranac.com/man/tonclib/</a>
  </li>
</ul>
<ul>
  <li>Example binaries : <a href="/files/tonc-bin.zip">tonc-bin.zip</a> (521k)
  </li>
  <li>Example code + tonclib : <a href="/files/tonc-code.zip">tonc-code.zip</a> (1.1M)
  </li>
  <li>Text + images : <a href="/files/tonc-text.zip">tonc-text.zip</a> (1.4M)
  </li>
  <li>Text in CHM : <a href="/files/tonc.chm">tonc.chm</a> (1.7M)
  </li>
  <li>Text in PDF : <a href="/files/tonc.pdf">tonc.pdf</a> (6.9M. No, I don't know where the extra 3 MB came from either.)
  </li>
</ul><br />

<p>
Right! Now what &hellip;
</p>	</div>
	<div class="feedback">
		<a href="http://www.coranac.com/2008/08/19/tonc-14-official-release/#comments" title="Comment on tonc 1.4 official release">Comments (5)</a>	</div>
</div>





<!-- begin footer -->
</div>

<!-- begin sidebar -->
<div id="menu">

<ul>
	<li class="pagenav">Pages:<ul><li class="page_item page-item-2"><a href="http://www.coranac.com/about/" title="About">About</a></li>
<li class="page_item page-item-6"><a href="http://www.coranac.com/documents/" title="Documents">Documents</a></li>
<li class="page_item page-item-10"><a href="http://www.coranac.com/links/" title="links">links</a></li>
<li class="page_item page-item-21"><a href="http://www.coranac.com/projects/" title="Projects">Projects</a></li>
</ul></li>	<li id="linkcat-2" class="linkcat">Blogroll
	<ul class='xoxo blogroll'>
<li><a href="http://www.badastronomy.com/" title="Astronomy related news debunking of heavenly myths.">Bad Astronomy</a></li>
<li><a href="http://www.codinghorror.com/blog/" title="Programming and human factors">Coding Horror</a></li>
<li><a href="http://www.scienceblogs.com/pharyngula/" title="Evolution, development, and random biological ejaculations from a godless liberal">pharyngula</a></li>
<li><a href="http://skeptico.blogs.com/" title="Critical thinking for an irrational world.">Skeptico</a></li>
<li><a href="http://worsethanfailure.com/Default.aspx" title="Curious perversions in information technology">Worse than failure</a></li>

	</ul>
</li>
<li id="linkcat-11" class="linkcat">Internal
	<ul class='xoxo blogroll'>
<li><a href="http://www.coranac.com">home</a></li>
<li><a href="http://www.coranac.com/tonc/text/" title="Tonc hub">Tonc</a></li>

	</ul>
</li>
	<li class="categories">Post categories:<ul>	<li class="cat-item cat-item-58"><a href="http://www.coranac.com/category/blag/" title="View all posts filed under blag">blag</a> (1)
</li>
	<li class="cat-item cat-item-22"><a href="http://www.coranac.com/category/code/" title="Assorted code snippets.">code</a> (11)
</li>
	<li class="cat-item cat-item-3"><a href="http://www.coranac.com/category/doc/" title="View all posts filed under documents">documents</a> (4)
</li>
	<li class="cat-item cat-item-30"><a href="http://www.coranac.com/category/math/" title="View all posts filed under math">math</a> (3)
</li>
	<li class="cat-item cat-item-35"><a href="http://www.coranac.com/category/nds/" title="View all posts filed under nds">nds</a> (3)
</li>
	<li class="cat-item cat-item-4"><a href="http://www.coranac.com/category/proj/" title="View all posts filed under projects">projects</a> (23)
<ul class='children'>
	<li class="cat-item cat-item-7"><a href="http://www.coranac.com/category/proj/grit/" title="The GBA Raster Image Transmogrifier. An open source graphics converter for GBA/NDS. Can convert from almost any image type to any NDS/GBA format. Comes in two flavors: command-line interface (multi-platform) and GUI (windows only).">grit</a> (11)
</li>
	<li class="cat-item cat-item-5"><a href="http://www.coranac.com/category/proj/tonc/" title="A detailed look into GBA programming. Tonc&#039;s text comes in html, chm and pdf. The library code, tonclib, is a mix of C and assembly. The many examples come in C and their binaries are runnable on emulators and hardware.">tonc</a> (12)
</li>
	<li class="cat-item cat-item-6"><a href="http://www.coranac.com/category/proj/usenti/" title="A (usually) simple to use editor for paletted images. It can handle bmp, pcx, png and tga files, has a number of useful palette manipulating tools and can export to GBA/NDS graphics formats.">usenti</a> (4)
</li>
</ul>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.coranac.com/category/tainment/" title="View all posts filed under tainment">tainment</a> (6)
</li>
	<li class="cat-item cat-item-1"><a href="http://www.coranac.com/category/uncategorized/" title="View all posts filed under Uncategorized">Uncategorized</a> (6)
</li>
</ul></li>  <li id="archives">Archives:
	  <select name="cb-archive" style="width:90%;"
	    onChange='document.location.href=this.options[this.selectedIndex].value;'>
	    <option value="">
		  Select Month	    </option>
			<option value='http://www.coranac.com/2009/06/'> June 2009 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2009/05/'> May 2009 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2009/04/'> April 2009 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2009/02/'> February 2009 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2008/12/'> December 2008 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2008/11/'> November 2008 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2008/09/'> September 2008 &nbsp;(4)</option>
	<option value='http://www.coranac.com/2008/08/'> August 2008 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2008/06/'> June 2008 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2008/05/'> May 2008 &nbsp;(5)</option>
	<option value='http://www.coranac.com/2008/04/'> April 2008 &nbsp;(3)</option>
	<option value='http://www.coranac.com/2008/02/'> February 2008 &nbsp;(4)</option>
	<option value='http://www.coranac.com/2008/01/'> January 2008 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2007/12/'> December 2007 &nbsp;(5)</option>
	<option value='http://www.coranac.com/2007/11/'> November 2007 &nbsp;(3)</option>
	<option value='http://www.coranac.com/2007/10/'> October 2007 &nbsp;(4)</option>
	<option value='http://www.coranac.com/2007/06/'> June 2007 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2007/04/'> April 2007 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2007/03/'> March 2007 &nbsp;(2)</option>
	<option value='http://www.coranac.com/2007/02/'> February 2007 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2007/01/'> January 2007 &nbsp;(1)</option>
	<option value='http://www.coranac.com/2006/08/'> August 2006 &nbsp;(1)</option>
	  </select>
  </li>
  <li id="search">
    <label for="s">Search:</label>
    <form id="searchform" method="get" action="http://www.coranac.com">
	<div>
		<input type="text" name="s" id="s" size="16" /><br />
		<input type="submit" value="Search" />
	</div>
	</form>
  </li>
  <li id="meta">Meta:
	<ul>
				<li><a href="http://www.coranac.com/wordpress/wp-login.php">Log in</a></li>
		<li><a href="http://www.coranac.com/feed/" title="Syndicate this site using RSS"><abbr title="Really Simple Syndication">RSS</abbr></a></li>
		<li><a href="http://www.coranac.com/comments/feed/" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<!--
		<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
		<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
		<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform."><abbr title="WordPress">WP</abbr></a></li>
-->
			</ul>
 </li>

</ul>

<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="image" src="https://www.paypal.com/en_US/i/btn/x-click-but11.gif" name="submit"
  alt="Please leave a contribution in the leetle box :)" />
<img src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1"  alt=""/>
<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
" />
</form>

<div>&nbsp;</div>

<script type="text/javascript"><!--
google_ad_client = "pub-9716169502604225";
/* 120x600 home 20080922 */
google_ad_slot = "0748086420";
google_ad_width = 120;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>
<!-- end sidebar -->

<p class="credit"><!--19 queries. 0.477 seconds. --> <cite>Powered by <a href='http://wordpress.org/' title='Powered by WordPress, state-of-the-art semantic personal publishing platform.'><strong>WordPress</strong></a></cite></p>

</div>

</body>
</html>
<!--
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
</head>
<body>
<p>
My database has called in sick. Please imagine some 
annoying elevator tune till he gets back.
</p>
<p>
<small>[[Doo-di-doo tooo. Dum-di-dum-di-doo-dooo.]]</small>
</p>
</body>
</html>

-->